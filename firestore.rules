rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }

    // Helper function to check if user is an editor
    function isEditor() {
      return isAuthenticated() && request.auth.token.role == 'editor';
    }

    // Experiences collection - public read, editor write
    match /experiences/{experienceId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // Blurbs collection - public read, editor write
    match /blurbs/{blurbId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // Generator defaults - public read, editor write
    match /generator_defaults/{defaultId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // Generator blurbs (AI prompts) - public read, editor write
    match /generator_blurbs/{blurbId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // Generator history - editor-only read/write
    match /generator_history/{requestId} {
      allow read, write: if isEditor();
    }

    // Job matches - editor-only read/write
    match /job-matches/{jobMatchId} {
      allow read, write: if isEditor();
    }

    // Job queue - viewers can read their own submissions, editors can read/write all
    match /job-queue/{queueItemId} {
      // Viewers can read their own queue items
      allow read: if isAuthenticated() && (
        resource.data.submitted_by == request.auth.uid || isEditor()
      );
      // Viewers can create new queue items
      allow create: if isAuthenticated() && request.resource.data.submitted_by == request.auth.uid;
      // Only editors can update or delete
      allow update, delete: if isEditor();
    }

    // Job finder configuration - editor-only read/write
    match /job-finder-config/{configId} {
      allow read, write: if isEditor();
    }

    // Content items (unified experience system) - public read, editor write
    match /content-items/{itemId} {
      allow read: if true;
      allow write: if isEditor();
    }

    // Default deny all other collections
    match /{document=**} {
      allow read, write: if false;
    }
  }
}